<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帥仙迴轉火鍋線上訂位系統</title>
    <!-- 載入必要 CDN 資源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 載入字體：思源黑體 (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* 全域強制字體，徹底禁用新細明體 */
        * {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif !important;
            -webkit-font-smoothing: antialiased;
        }

        body { 
            background-color: #FFF5F7; 
        }

        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 恢復最初版輸入框樣式：半透明、圓角、粉邊 */
        .original-input-style {
            width: 100%;
            padding: 0.85rem 1.25rem;
            border: 1px solid #fecdd3; /* pink-200 */
            border-radius: 1rem;
            background-color: rgba(255, 255, 255, 0.6);
            outline: none;
            transition: all 0.2s ease;
            color: #4b5563;
            font-size: 1rem;
        }

        .original-input-style:focus {
            background-color: #ffffff;
            border-color: #f472b6;
            box-shadow: 0 0 0 4px rgba(244, 114, 182, 0.15);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        // 【核心配置區】
        // 請在此處填入您的 Google Apps Script 網址 (記得最後要有 /exec)
        // ==========================================
        const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbw_M_6ZYCpDgUdmZjKPd30ZuvT29EXHjTjDfwlUCE7FT033CS5rEX_g777S1U8pUn_g7Q/exec"; 
        const MAX_CAPACITY = 25; 
        // ==========================================

        const App = () => {
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [occupancyData, setOccupancyData] = useState({});
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [formData, setFormData] = useState({
                name: '', email: '', phone: '',
                date: new Date().toISOString().split('T')[0],
                time: '', guests: '2', notes: ''
            });

            // 初始化 Lucide 圖示
            useEffect(() => { 
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [step]);

            // 定期讀取名額資訊
            useEffect(() => {
                if (!GOOGLE_SHEETS_URL) return;
                fetch(GOOGLE_SHEETS_URL)
                    .then(res => res.json())
                    .then(data => setOccupancyData(data))
                    .catch(err => console.log("等待 API 設定中..."));
            }, [step]);

            const timeSlots = useMemo(() => {
                const slots = [];
                for (let h = 11; h <= 22; h++) {
                    const p = h >= 12 ? 'PM' : 'AM';
                    let dh = h > 12 ? h - 12 : h;
                    if (dh === 0) dh = 12;
                    slots.push(`${dh}:00${p}`);
                    if (h !== 22) slots.push(`${dh}:30${p}`);
                }
                return slots;
            }, []);

            const calendarDays = useMemo(() => {
                const y = currentMonth.getFullYear();
                const m = currentMonth.getMonth();
                const firstDay = new Date(y, m, 1).getDay();
                const total = new Date(y, m + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(null);
                for (let i = 1; i <= total; i++) days.push(new Date(y, m, i));
                return days;
            }, [currentMonth]);

            const handleFinalSubmit = async () => {
                if (!GOOGLE_SHEETS_URL) {
                    alert("請先在程式碼中填入 Google 試算表 API 網址！");
                    return;
                }
                setLoading(true);
                try {
                    await fetch(GOOGLE_SHEETS_URL, {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    setStep(6);
                } catch (e) {
                    console.error(e);
                    // 由於 no-cors 模式會導致 fetch 丟出 Error 但實際成功，
                    // 若 GAS 正常，通常資料已經進去了。
                    setStep(6); 
                } finally {
                    setLoading(false);
                }
            };

            const btnPrimary = "w-full bg-pink-500 hover:bg-pink-600 disabled:bg-pink-100 text-white font-black py-5 rounded-[2.5rem] shadow-xl transition-all transform active:scale-95 flex items-center justify-center gap-2";

            return (
                <div className="min-h-screen flex items-center justify-center p-0 sm:p-4">
                    <div className="w-full max-w-md bg-white min-h-screen sm:min-h-[820px] sm:rounded-[50px] shadow-2xl flex flex-col border border-pink-50 overflow-hidden relative">
                        
                        {/* Header */}
                        <div className="px-6 py-6 flex items-center justify-between border-b border-pink-50 bg-white/95 sticky top-0 z-30">
                            <button onClick={() => step > 1 && step < 6 && setStep(step - 1)} className={`p-2 ${step > 1 && step < 6 ? 'opacity-100 text-pink-500' : 'opacity-0'}`}>
                                <i data-lucide="chevron-left"></i>
                            </button>
                            <div className="text-center">
                                <h1 className="text-base font-black text-pink-600 tracking-[0.2em] uppercase italic">帥仙迴轉火鍋</h1>
                                <p className="text-[10px] text-pink-300 font-bold uppercase">{step === 6 ? 'SUCCESS' : `Step ${step} / 5`}</p>
                            </div>
                            <div className="p-2 opacity-5"><i data-lucide="x"></i></div>
                        </div>

                        <div className="flex-1 overflow-y-auto no-scrollbar pb-8">
                            
                            {/* STEP 1: 個人資料 - 最初版字體與輸入框樣式 */}
                            {step === 1 && (
                                <div className="p-8 space-y-8 animate-in">
                                    <div className="text-center space-y-2">
                                        <h2 className="text-3xl font-black text-gray-800 tracking-tight">線上訂位系統</h2>
                                        <p className="text-pink-400 font-bold text-sm italic underline decoration-pink-100 underline-offset-4">Shuai Xian Reservation</p>
                                    </div>
                                    <div className="space-y-6">
                                        <div className="space-y-1.5">
                                            <label className="text-pink-600 text-xs font-bold px-1.5 flex items-center gap-1.5"><i data-lucide="user" size={14}></i> 姓名</label>
                                            <input type="text" placeholder="預約姓名" className="original-input-style" onChange={e => setFormData({...formData, name: e.target.value})} value={formData.name} />
                                        </div>
                                        <div className="space-y-1.5">
                                            <label className="text-pink-600 text-xs font-bold px-1.5 flex items-center gap-1.5"><i data-lucide="phone" size={14}></i> 手機號碼</label>
                                            <input type="tel" placeholder="0912-345-678" className="original-input-style" onChange={e => setFormData({...formData, phone: e.target.value})} value={formData.phone} />
                                        </div>
                                        <div className="space-y-1.5">
                                            <label className="text-pink-600 text-xs font-bold px-1.5 flex items-center gap-1.5"><i data-lucide="mail" size={14}></i> 電子郵件 (選填)</label>
                                            <input type="email" placeholder="example@mail.com" className="original-input-style" onChange={e => setFormData({...formData, email: e.target.value})} value={formData.email} />
                                        </div>
                                    </div>
                                    <button onClick={() => setStep(2)} disabled={!formData.name || !formData.phone} className={btnPrimary}>挑選預約日期</button>
                                </div>
                            )}

                            {/* STEP 2: 日曆 */}
                            {step === 2 && (
                                <div className="p-6 space-y-6 animate-in">
                                    <div className="text-center font-black text-2xl text-gray-800">選擇日期</div>
                                    <div className="bg-white rounded-[2.5rem] p-5 border-2 border-pink-50 shadow-sm">
                                        <div className="flex items-center justify-between mb-6 px-2">
                                            <h3 className="font-black text-gray-700">{currentMonth.toLocaleString('zh-TW', { month: 'long', year: 'numeric' })}</h3>
                                            <div className="flex gap-2 text-pink-400">
                                                <button onClick={() => setCurrentMonth(new Date(currentMon
